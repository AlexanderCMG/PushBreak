<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Experiment</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <img id="logo" src="uvalogo.png" alt="UVA Logo" class="logo">
            <button id="stopButton" class="btn btn-stop" onclick="stopExperiment()">Stop Experiment</button>
        </div>

        <!-- Setup Screen -->
        <div id="setupScreen" class="setup-screen">
            <div class="setup-content">
                <div class="participantNumber">
                    <label for="participantNumber">Participant Number:</label>
                    <input type="number" id="participantNumber" value="0" min="0" max="30" placeholder="Enter your participant number" required>
                </div>
                <div class="input-group">
                    <label for="sessionDuration">Task Duration (minutes):</label>
                    <input type="number" id="sessionDuration" value="2" min="1" max="30">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="colorblindMode">
                    <label for="colorblindMode">Colorblind Mode (simplified colors)</label>
                </div>
                <button class="btn" onclick="startExperiment()">Start Experiment</button>
            </div>
        </div>

        <!-- Experiment Screen -->
        <div id="experimentScreen" class="experiment-screen">
            <div class="controls">
                <button class="btn btn-stop" onclick="stopExperiment()">Stop Experiment</button>
            </div>
            <div class="passage-container">
                <div id="passageText" class="passage-text"></div>
            </div>
            <div class="input-section">
                <textarea id="inputArea" class="input-area" placeholder="Start typing here..." autocomplete="off" spellcheck="false"></textarea>
            </div>
        </div>

        <!-- Break Screen -->
        <div id="breakScreen" class="break-screen">
            <h2>Your next task will start in 30 seconds</h2>
            <div class="break-timer" id="breakTimer">30</div>
            <p>Get ready for the next task...</p>
        </div>

        <!-- Completion Screen -->
        <div id="completionScreen" class="completion-screen">
            <div class="completion-message">
                <h2>Thank you!</h2>
                <p>The experiment has been completed successfully.<br>
                Your data has been recorded.<br><br>
                You may now close this window and return to the survey.</p>
            </div>
        </div>
    </div>

    <script>
        const passages = [
            "Jake slammed his fingers across the black keys of his guitar, the red stage lights blazzing overhead as purple smoke billowed from the machines behind him. The crowd was absolutly electric tonight, screaming for more as sweat dripped from his forhead. He had dreamed of this moment since he was twelve years old, practicing in his parent's garage until the neigbors would complain.\nThe blue spotlight found him in the darkniss, illuminating his silver chains and the green dragon tattoo that coiled around his left arm. His voice echoed through the massive amplifires, each note carring the raw emotion he had poured into his music for years. The audience swayed like ocean waves, completly mesmerized by the power flowing from the stage.\nBehind him, the drummer pounded out a ryhthm on his white drum kit while orange flames shot up from the stage floor, creating yellow shadows that danced accross the packed arena. Jake's guitar solo reached its cressendo, his fingers moving so fast they were barely visable to the naked eye. This was what he lived for â€“ the pure adrenalin rush of performing for thousands of devoted fans.\nThe red curtains parted to reveel his backup singers, their blue sequined dresses sparkling under the bright white stage lites that swept across the venue. The bass line thumped through everyone's chest, making hearts beat in perfect rythm with the music. Jake had fought for years to reach this level of success, facing rejection after rejection from record lables who didn't understand his vision.\nPurple bannars hung from the ceiling while green laser beams cut through the thick yellow haze that filled the concert hall. His manager had warned him that tonite's performance would make or brake his career, but Jake felt nothing but confidence flowing through his vains. The energy from the crowd was intoxicating, feeding his soul and pushing him to deliever the performance of a lifetime."
        ];

        let currentPassage = '';
        let expectedText = '';
        let sessionDuration = 2;
        let currentSession = 1;
        let sessionStartTime = 0;
        let sessionTimer = null;
        let breakTimer = null;
        let experimentData = [];
        let isExperimentActive = false;
        let colorAssignments = {};
        let isColorblindMode = false;

        // Advanced accuracy tracking
        let accuracyTracker = {
            totalCorrectChars: 0,
            totalAttemptedChars: 0,
            corrections: 0,
            lastValidPosition: 0,
            positionMap: new Map(), // Maps input position to expected text position
            reset: function() {
                this.totalCorrectChars = 0;
                this.totalAttemptedChars = 0;
                this.corrections = 0;
                this.lastValidPosition = 0;
                this.positionMap.clear();
            }
        };

        // Color word mappings
        const colorWords = [
            'red', 'orange', 'yellow', 'green', 'blue', 'purple', 'pink', 'white', 'black',
            'silver', 'gold', 'golden', 'crimson', 'scarlet', 'amber', 'lime', 'emerald', 'jade',
            'sapphire', 'cobalt', 'navy', 'violet', 'magenta', 'rose', 'coral', 'turquoise',
            'cyan', 'maroon', 'burgundy', 'olive', 'khaki', 'tan', 'beige', 'ivory', 'gray', 'grey'
        ];

        const colorblindColors = ['blue', 'yellow', 'black', 'white'];
        const normalColors = ['red', 'orange', 'yellow', 'green', 'blue', 'purple', 'pink', 'white', 'black'];

        function getRandomPassage() {
            return passages[Math.floor(Math.random() * passages.length)];
        }

        function startExperiment() {
            sessionDuration = parseInt(document.getElementById('sessionDuration').value);
            isColorblindMode = document.getElementById('colorblindMode').checked;

            if (sessionDuration < 1) {
                alert('Please enter a valid duration (at least 1 minute)');
                return;
            }

            // Apply colorblind mode class
            document.body.classList.toggle('colorblind', isColorblindMode);

            // Show the stop button
            document.getElementById('stopButton').style.display = 'block';

            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('experimentScreen').style.display = 'flex';

            isExperimentActive = true;
            currentSession = 1;
            experimentData = [];

            startSession();
        }

        function startSession() {
            currentPassage = getRandomPassage();
            colorAssignments = {};
            accuracyTracker.reset();

            assignColorsToPassage();
            console.log('Color Assignments:', colorAssignments);
            createExpectedText();
            displayPassage();

            const inputArea = document.getElementById('inputArea');
            inputArea.value = '';
            inputArea.focus();

            sessionStartTime = Date.now();
            updateTimer();

            sessionTimer = setInterval(() => {
                updateTimer();
                console.log('Session Timer:', Math.floor((Date.now() - sessionStartTime) / 1000), 'seconds elapsed');
            }, 1000);

            setTimeout(() => {
                endSession();
            }, sessionDuration * 60 * 1000);
        }

        function assignColorsToPassage() {
            const availableColors = isColorblindMode ? colorblindColors : normalColors;
            const foundColorWords = new Set();
            const usedColors = new Set();

            // Find all color words in the passage
            const paragraphs = currentPassage.split('\n');
            paragraphs.forEach(paragraph => {
                const words = paragraph.split(/(\s+)/);
                words.forEach(word => {
                    const cleanWord = word.toLowerCase().replace(/[^\w]/g, '');
                    if (colorWords.includes(cleanWord)) {
                        foundColorWords.add(cleanWord);
                    }
                });
            });

            // Assign colors to each unique color word
            foundColorWords.forEach(colorWord => {
                const matchingBaseColor = getMatchingBaseColor(colorWord);
                let availableOptions = availableColors.filter(color =>
                    color !== matchingBaseColor && !usedColors.has(color)
                );

                if (availableOptions.length === 0) {
                    availableOptions = availableColors.filter(color => color !== matchingBaseColor);
                    usedColors.clear();
                }

                const selectedColor = availableOptions[Math.floor(Math.random() * availableOptions.length)];
                usedColors.add(selectedColor);
                colorAssignments[colorWord] = selectedColor;
            });
        }

        function getMatchingBaseColor(colorWord) {
            const mappings = {
                'crimson': 'red', 'scarlet': 'red', 'maroon': 'red', 'burgundy': 'red',
                'amber': 'yellow', 'gold': 'yellow', 'golden': 'yellow', 'khaki': 'yellow', 'tan': 'yellow', 'beige': 'yellow',
                'lime': 'green', 'emerald': 'green', 'jade': 'green', 'olive': 'green',
                'sapphire': 'blue', 'cobalt': 'blue', 'navy': 'blue', 'turquoise': 'blue', 'cyan': 'blue',
                'violet': 'purple', 'magenta': 'purple',
                'rose': 'pink', 'coral': 'orange',
                'silver': 'white', 'ivory': 'white',
                'gray': 'black', 'grey': 'black'
            };
            return mappings[colorWord] || colorWord;
        }

        function createExpectedText() {
            // Create a regex pattern that matches all color words we need to replace
            const colorWordPattern = new RegExp(
                `\\b(${Object.keys(colorAssignments).join('|')})\\b`,
                'gi'
            );

            // Replace all color words in one pass
            expectedText = currentPassage.replace(colorWordPattern, (match) => {
                const lowerMatch = match.toLowerCase();
                return colorAssignments[lowerMatch] || match;
            });
        }

        function displayPassage() {
            const passageElement = document.getElementById('passageText');
            let displayText = '';

            const paragraphs = currentPassage.split('\n');
            paragraphs.forEach((paragraph, paragraphIndex) => {
                if (paragraphIndex > 0) {
                    displayText += '\n';
                }

                const words = paragraph.split(/(\s+)/);
                words.forEach(word => {
                    const cleanWord = word.toLowerCase().replace(/[^\w]/g, '');

                    if (colorWords.includes(cleanWord) && colorAssignments[cleanWord]) {
                        const highlightClass = `highlight-${colorAssignments[cleanWord]}`;
                        displayText += `<span class="${highlightClass}">${word}</span>`;
                    } else {
                        displayText += word;
                    }
                });
            });

            passageElement.innerHTML = displayText;
        }

        function calculateAdvancedAccuracy(inputText) {
            const input = inputText;
            const expected = expectedText;

            let inputPos = 0;
            let expectedPos = 0;
            let correctChars = 0;
            let totalProcessedChars = 0;

            // Reset position map for this calculation
            accuracyTracker.positionMap.clear();

            while (inputPos < input.length && expectedPos < expected.length) {
                totalProcessedChars++;

                if (input[inputPos] === expected[expectedPos]) {
                    // Direct match
                    correctChars++;
                    accuracyTracker.positionMap.set(inputPos, expectedPos);
                    inputPos++;
                    expectedPos++;
                } else {
                    // Look ahead in input to find next matching sequence
                    let foundMatch = false;
                    let lookAheadInput = inputPos + 1;

                    // Look up to 10 characters ahead in input
                    while (lookAheadInput < Math.min(input.length, inputPos + 10)) {
                        if (input[lookAheadInput] === expected[expectedPos]) {
                            // Found a match, check if it's a substantial sequence (at least 3 chars)
                            let seqLength = 0;
                            let tempInputPos = lookAheadInput;
                            let tempExpectedPos = expectedPos;

                            while (tempInputPos < input.length &&
                                   tempExpectedPos < expected.length &&
                                   input[tempInputPos] === expected[tempExpectedPos] &&
                                   seqLength < 5) {
                                seqLength++;
                                tempInputPos++;
                                tempExpectedPos++;
                            }

                            if (seqLength >= 3) {
                                // Valid sequence found, skip the incorrect part in input
                                inputPos = lookAheadInput;
                                foundMatch = true;
                                break;
                            }
                        }
                        lookAheadInput++;
                    }

                    if (!foundMatch) {
                        // No good match found, advance both pointers
                        inputPos++;
                        expectedPos++;
                    }
                }
            }

            // Handle any remaining characters in input as attempted
            totalProcessedChars += Math.max(0, input.length - inputPos);

            accuracyTracker.totalCorrectChars = correctChars;
            accuracyTracker.totalAttemptedChars = Math.max(totalProcessedChars, input.length);

            return accuracyTracker.totalAttemptedChars > 0 ?
                (accuracyTracker.totalCorrectChars / accuracyTracker.totalAttemptedChars) * 100 : 100;
        }

        function updateTimer() {
            const elapsed = (Date.now() - sessionStartTime) / 1000;
            const remaining = Math.max(0, (sessionDuration * 60) - elapsed);
            const minutes = Math.floor(remaining / 60);
            const seconds = Math.floor(remaining % 60);
            // document.getElementById('timeStat').textContent =
            //     `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function endSession() {
            if (!isExperimentActive) return;

            clearInterval(sessionTimer);

            const inputText = document.getElementById('inputArea').value;
            const accuracy = calculateAdvancedAccuracy(inputText);
            const elapsed = (Date.now() - sessionStartTime) / 1000 / 60;
            const wpm = Math.round((accuracyTracker.totalCorrectChars / 5) / elapsed);

            experimentData.push({
                session: currentSession,
                wpm: wpm,
                accuracy: Math.round(accuracy),
                passage: currentPassage,
                expectedText: expectedText,
                typedText: inputText,
                duration: sessionDuration,
                totalChars: accuracyTracker.totalAttemptedChars,
                correctChars: accuracyTracker.totalCorrectChars,
                colorblindMode: isColorblindMode,
                colorAssignments: { ...colorAssignments }
            });

            if (currentSession < 10) {
                startBreak();
            } else {
                showCompletion();
            }
        }

        function startBreak() {
            document.getElementById('experimentScreen').style.display = 'none';
            document.getElementById('breakScreen').style.display = 'flex';

            let breakTime = 30;
            document.getElementById('breakTimer').textContent = breakTime;

            breakTimer = setInterval(() => {
                breakTime--;
                document.getElementById('breakTimer').textContent = breakTime;

                if (breakTime <= 0) {
                    clearInterval(breakTimer);
                    document.getElementById('breakScreen').style.display = 'none';
                    document.getElementById('experimentScreen').style.display = 'flex';
                    currentSession++;
                    startSession();
                }
            }, 1000);
        }

        function showCompletion() {
            isExperimentActive = false;
            document.getElementById('stopButton').style.display = 'none';
            document.getElementById('experimentScreen').style.display = 'none';
            document.getElementById('completionScreen').style.display = 'flex';

            console.log('Experiment data:', experimentData);
        }

        function stopExperiment() {
            isExperimentActive = false;
            clearInterval(sessionTimer);
            clearInterval(breakTimer);
            showCompletion();
        }

        // Event listeners
        document.getElementById('inputArea').addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
            }
        });

        // Initialize
        document.getElementById('setupScreen').style.display = 'flex';
        document.getElementById('stopButton').style.display = 'none';
    </script>
</body>
</html>
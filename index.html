<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Experiment</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Setup Screen -->
        <div id="setupScreen" class="setup-screen">
            <div class="input-group">
                <label for="sessionDuration">Session Duration (minutes):</label>
                <input type="number" id="sessionDuration" value="2" min="1" max="30">
            </div>
            <button class="btn" onclick="startExperiment()">Start Experiment</button>
        </div>

        <!-- Experiment Screen -->
        <div id="experimentScreen" class="experiment-screen">
            <div id="timer" class="timer"></div>
            <div class="passage-container">
                <div id="passageText" class="passage-text"></div>
                <textarea id="inputArea" class="input-area" placeholder="Start typing here..." autocomplete="off" spellcheck="false"></textarea>
            </div>

            <button class="btn btn-stop" onclick="stopExperiment()">Stop Experiment</button>
        </div>

        <!-- Break Screen -->
        <div id="breakScreen" class="break-screen">
            <h2>Take a 30-second break</h2>
            <div class="break-timer" id="breakTimer">30</div>
            <p>Get ready for the next session...</p>
        </div>

        <!-- Completion Screen -->
        <div id="completionScreen" class="completion-screen">
            <div class="completion-message">
                <h2>Thank you for participating!</h2>
                <p>The experiment has been completed successfully.<br>
                Your data has been recorded.<br><br>
                You may now close this window.</p>
            </div>
        </div>
    </div>

    <script>
        const passages = [
            "Jake slammed his fingers across the black keys of his guitar, the red stage lights blazzing overhead as purple smoke billowed from the machines behind him. The crowd was absolutly electric tonight, screaming for more as sweat dripped from his forhead. He had dreamed of this moment since he was twelve years old, practicing in his parent's garage until the neigbors would complain.\nThe blue spotlight found him in the darkniss, illuminating his silver chains and the green dragon tattoo that coiled around his left arm. His voice echoed through the massive amplifires, each note carring the raw emotion he had poured into his music for years. The audience swayed like ocean waves, completly mesmerized by the power flowing from the stage.\nBehind him, the drummer pounded out a ryhthm on his white drum kit while orange flames shot up from the stage floor, creating yellow shadows that danced accross the packed arena. Jake's guitar solo reached its cressendo, his fingers moving so fast they were barely visable to the naked eye. This was what he lived for â€“ the pure adrenalin rush of performing for thousands of devoted fans.\nThe red curtains parted to reveel his backup singers, their blue sequined dresses sparkling under the bright white stage lites that swept across the venue. The bass line thumped through everyone's chest, making hearts beat in perfect rythm with the music. Jake had fought for years to reach this level of success, facing rejection after rejection from record lables who didn't understand his vision.\nPurple bannars hung from the ceiling while green laser beams cut through the thick yellow haze that filled the concert hall. His manager had warned him that tonite's performance would make or brake his career, but Jake felt nothing but confidence flowing through his vains. The energy from the crowd was intoxicating, feeding his soul and pushing him to deliever the performance of a lifetime."
        ];

        let currentPassage = '';
        let currentPosition = 0;
        let sessionDuration = 2; // minutes
        let currentSession = 1;
        let sessionStartTime = 0;
        let sessionTimer = null;
        let breakTimer = null;
        let experimentData = [];
        let isExperimentActive = false;
        let totalTypedChars = 0;
        let correctChars = 0;
        let colorAssignments = {}; // Store color assignments for the current passage

        function getRandomPassage() {
            return passages[Math.floor(Math.random() * passages.length)];
        }

        function stripHTML(html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            return temp.textContent || temp.innerText || '';
        }

        function startExperiment() {
            sessionDuration = parseInt(document.getElementById('sessionDuration').value);
            if (sessionDuration < 1) {
                alert('Please enter a valid duration (at least 1 minute)');
                return;
            }

            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('experimentScreen').style.display = 'block';

            isExperimentActive = true;
            currentSession = 1;
            experimentData = [];

            startSession();
        }

        function startSession() {
            currentPassage = getRandomPassage();
            currentPosition = 0;
            totalTypedChars = 0;
            correctChars = 0;
            colorAssignments = {};

            displayPassage();

            const inputArea = document.getElementById('inputArea');
            inputArea.value = '';
            inputArea.focus();

            sessionStartTime = Date.now();
            updateTimer();

            sessionTimer = setInterval(() => {
                updateTimer();
                updateStats();
            }, 1000);

            setTimeout(() => {
                endSession();
            }, sessionDuration * 60 * 1000);
        }

        function assignColorsToPassage() {
            // Define color words to detect
            const colorWords = [
                'red', 'orange', 'yellow', 'green', 'blue', 'purple', 'pink', 'white', 'black',
                'silver', 'gold', 'golden', 'crimson', 'scarlet', 'amber', 'lime', 'emerald', 'jade',
                'sapphire', 'cobalt', 'navy', 'violet', 'magenta', 'rose', 'coral', 'turquoise',
                'cyan', 'maroon', 'burgundy', 'olive', 'khaki', 'tan', 'beige', 'ivory', 'gray', 'grey'
            ];

            // Base colors for highlighting classes
            const baseColors = ['red', 'orange', 'yellow', 'green', 'blue', 'purple', 'pink', 'white', 'black'];

            // Function to get a random color different from the detected word
            function getRandomColor(detectedWord) {
                // Get the base color that matches the detected word (if any)
                const matchingBaseColor = baseColors.find(color =>
                    detectedWord === color ||
                    (detectedWord === 'crimson' && color === 'red') ||
                    (detectedWord === 'scarlet' && color === 'red') ||
                    (detectedWord === 'maroon' && color === 'red') ||
                    (detectedWord === 'burgundy' && color === 'red') ||
                    (detectedWord === 'amber' && color === 'yellow') ||
                    (detectedWord === 'gold' && color === 'yellow') ||
                    (detectedWord === 'golden' && color === 'yellow') ||
                    (detectedWord === 'lime' && color === 'green') ||
                    (detectedWord === 'emerald' && color === 'green') ||
                    (detectedWord === 'jade' && color === 'green') ||
                    (detectedWord === 'olive' && color === 'green') ||
                    (detectedWord === 'sapphire' && color === 'blue') ||
                    (detectedWord === 'cobalt' && color === 'blue') ||
                    (detectedWord === 'navy' && color === 'blue') ||
                    (detectedWord === 'turquoise' && color === 'blue') ||
                    (detectedWord === 'cyan' && color === 'blue') ||
                    (detectedWord === 'violet' && color === 'purple') ||
                    (detectedWord === 'magenta' && color === 'purple') ||
                    (detectedWord === 'rose' && color === 'pink') ||
                    (detectedWord === 'coral' && color === 'orange') ||
                    (detectedWord === 'khaki' && color === 'yellow') ||
                    (detectedWord === 'tan' && color === 'yellow') ||
                    (detectedWord === 'beige' && color === 'yellow') ||
                    (detectedWord === 'silver' && color === 'white') ||
                    (detectedWord === 'ivory' && color === 'white') ||
                    (detectedWord === 'gray' && color === 'black') ||
                    (detectedWord === 'grey' && color === 'black')
                );

                // Filter out the matching color to avoid using the same color
                const availableColors = baseColors.filter(color => color !== matchingBaseColor);

                // Return a random color from the available options
                return availableColors[Math.floor(Math.random() * availableColors.length)];
            }

            // Split text into paragraphs first to preserve line breaks
            const paragraphs = currentPassage.split('\n');

            paragraphs.forEach(paragraph => {
                // Split paragraph into words while preserving spaces and punctuation
                const words = paragraph.split(/(\s+)/);

                words.forEach(word => {
                    // Extract the actual word without punctuation for color checking
                    const cleanWord = word.toLowerCase().replace(/[^\w]/g, '');

                    if (colorWords.includes(cleanWord) && !colorAssignments[cleanWord]) {
                        // Assign a color only if we haven't assigned one for this word yet
                        colorAssignments[cleanWord] = getRandomColor(cleanWord);
                    }
                });
            });
        }

        function displayPassage() {
            const passageElement = document.getElementById('passageText');
            const plainText = currentPassage;

            // Define color words to detect
            const colorWords = [
                'red', 'orange', 'yellow', 'green', 'blue', 'purple', 'pink', 'white', 'black',
                'silver', 'gold', 'golden', 'crimson', 'scarlet', 'amber', 'lime', 'emerald', 'jade',
                'sapphire', 'cobalt', 'navy', 'violet', 'magenta', 'rose', 'coral', 'turquoise',
                'cyan', 'maroon', 'burgundy', 'olive', 'khaki', 'tan', 'beige', 'ivory', 'gray', 'grey'
            ];

            // Assign colors if not already done
            if (Object.keys(colorAssignments).length === 0) {
                assignColorsToPassage();
            }

            // Split text into paragraphs first to preserve line breaks
            const paragraphs = plainText.split('\n');
            let displayText = '';

            paragraphs.forEach((paragraph, paragraphIndex) => {
                if (paragraphIndex > 0) {
                    displayText += '<br>'; // Add line break between paragraphs
                }

                // Split paragraph into words while preserving spaces and punctuation
                const words = paragraph.split(/(\s+)/);

                words.forEach(word => {
                    // Extract the actual word without punctuation for color checking
                    const cleanWord = word.toLowerCase().replace(/[^\w]/g, '');

                    if (colorWords.includes(cleanWord) && colorAssignments[cleanWord]) {
                        // Use the pre-assigned color
                        const highlightClass = `highlight-${colorAssignments[cleanWord]}`;
                        displayText += `<span class="${highlightClass}">${word}</span>`;
                    } else {
                        // Keep the word as is (including spaces and punctuation)
                        displayText += word;
                    }
                });
            });

            passageElement.innerHTML = displayText;
        }

        function updateTimer() {
            const elapsed = (Date.now() - sessionStartTime) / 1000;
            const remaining = Math.max(0, (sessionDuration * 60) - elapsed);
            const minutes = Math.floor(remaining / 60);
            const seconds = Math.floor(remaining % 60);
            document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateStats() {
            const inputText = document.getElementById('inputArea').value;
            const plainPassage = stripHTML(currentPassage);

            totalTypedChars = inputText.length;
            correctChars = 0;

            for (let i = 0; i < Math.min(inputText.length, plainPassage.length); i++) {
                if (inputText[i] === plainPassage[i]) {
                    correctChars++;
                }
            }

            const elapsed = (Date.now() - sessionStartTime) / 1000 / 60; // minutes
            const wpm = Math.round((correctChars / 5) / Math.max(elapsed, 0.1));
            const accuracy = totalTypedChars > 0 ? Math.round((correctChars / totalTypedChars) * 100) : 100;

            currentPosition = inputText.length;
            displayPassage();
        }

        function endSession() {
            if (!isExperimentActive) return;

            clearInterval(sessionTimer);

            // Record session data
            const elapsed = (Date.now() - sessionStartTime) / 1000 / 60;
            const wpm = Math.round((correctChars / 5) / Math.max(elapsed, 0.1));
            const accuracy = totalTypedChars > 0 ? Math.round((correctChars / totalTypedChars) * 100) : 100;

            experimentData.push({
                session: currentSession,
                wpm: wpm,
                accuracy: accuracy,
                passage: stripHTML(currentPassage),
                typedText: document.getElementById('inputArea').value,
                duration: sessionDuration,
                totalChars: totalTypedChars,
                correctChars: correctChars
            });

            if (currentSession < 3) { // Continue for multiple sessions
                startBreak();
            } else {
                showCompletion();
            }
        }

        function startBreak() {
            document.getElementById('experimentScreen').style.display = 'none';
            document.getElementById('breakScreen').style.display = 'block';

            let breakTime = 30;
            document.getElementById('breakTimer').textContent = breakTime;

            breakTimer = setInterval(() => {
                breakTime--;
                document.getElementById('breakTimer').textContent = breakTime;

                if (breakTime <= 0) {
                    clearInterval(breakTimer);
                    document.getElementById('breakScreen').style.display = 'none';
                    document.getElementById('experimentScreen').style.display = 'block';
                    currentSession++;
                    startSession();
                }
            }, 1000);
        }

        function showCompletion() {
            isExperimentActive = false;
            document.getElementById('experimentScreen').style.display = 'none';
            document.getElementById('completionScreen').style.display = 'block';

            // Save data to CSV file
            saveDataToCSV();
        }


        function stopExperiment() {
            isExperimentActive = false;
            clearInterval(sessionTimer);
            clearInterval(breakTimer);
            showCompletion();
        }

        function resetExperiment() {
            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('breakScreen').style.display = 'none';
            document.getElementById('experimentScreen').style.display = 'none';
            document.getElementById('setupScreen').style.display = 'block';

            currentSession = 1;
            experimentData = [];
            isExperimentActive = false;
        }

        // Event listeners
        document.getElementById('inputArea').addEventListener('input', updateStats);

        document.getElementById('inputArea').addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
            }
        });

        // Initialize
        document.getElementById('setupScreen').style.display = 'block';
    </script>
</body>
</html>

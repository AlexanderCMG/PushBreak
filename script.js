const passages = [
    "Tom worked at a small green bike shop near the train station. Each morning, he opened the rusty white shutters and turned on the blue lights. The bikes always needed something, oil, air, or a new chain. He liked fixing them, even if he sometimes forgt where he left his wrench. His hands were always a bit greasy by 9 a.m.\nA boy came in with a broken red pedal, holding the bike by its black handlebars. Tom smiled and said, “We’ll get you riding again in no time.” He grabbed a yellow toolbox and got to work. The boy asked a lot of questions, which Tom liked. But then he droped a screw and spent five minutes looking for it under the bench.\nLater, a woman in a purple raincoat rolled in with a squeaky wheel. She said it had been acting funny since yesterday. Tom listened, tightened a few things, and gave her a pink receipt. “Try that now,” he said. She rode a few steps and smiled, though he notcied the bell was still loose.\nBy lunch, Tom sat on a crate near the back, eating a sandwich and sipping from a blue cup. A green towel was draped over his shoulder, and his notes sat next to a jar of loose red bolts. He checked the list of orders and wiped his hands. Then he realized he had put mustard on the top of the bread insted of the inside.\nThe afternoon got busier when a group of teens came in with muddy bikes. One had a black seat torn at the side, another needed a white tire pumped, and the third wanted a new orange bell. Tom took a breath and got started. He liked the work, even if he accidently grabbed the wrong size wrench twice.\nAround 4 p.m., his friend Liza stopped by wearing a pink hoodie and carrying a yellow smoothie. “Want to take a break?” she asked. Tom shook his head, pointing at a blue bike frame he was almost done painting. She nodded and sat nearby, chatting while he worked. He listened but occasionaly forgot to respond.\nAs the sun set, the shop glowed under the soft purple lights inside. Tom locked the green tool cabinet and swept the floor with a black broom. A few screws rolled into the corner and he made a note to grab them tomorrow. He felt tired but proud, even though his back was a little sore from bending to much.\nTom closed the shop and walked home under the white stars. He passed the quiet orange street and the small park with the red bench. Tomorrow would bring more bikes and more small problems to solve. But for now, he was happy and ready to rest, even if he had forgot his water bottle on the counter again.",
    "In a quiet alley behind the bakery, three black cats lived together beneath a rusted yellow dumpster and a pile of soft pink boxes. The space was small but warm, filled with the smell of old bread and dry leaves. Each morning, sunlight peeked through a broken fence and woke them slowly. One always snored, and the others alwasy flicked their tails in annoyance.\nThe alley was their world. There was a tall white gate they never climbed, a cold blue puddle that never dried, and a green bush where birds sometimes landed. The oldest cat guarded the area while the younger ones played. Sometimes they fought over scraps, but they always shared when it realy mattered.\nOne afternoon, a sudden gust of wind knocked over a purple crate, spilling wrappers across the concrete. The noise scared a flock of pigeons near a red pipe and made the smallest cat hide under a bent orange sign. The oldest one growled and hissed at the air, though there was nothing there to fight. Their fur stood up for a while befor they calmed down.\nIn the evening, rain began to fall. It hit the blue cans loudly and splashed into the yellow puddle until it overflowed. The cats squeezed together under the black boxes, noses pressed into fur, tails twitching. The youngest one sneezed twice, and the others stared at it like it had broken some unwriten rule.\nWhen the storm passed, the air was fresh and the alley sparkled. A stray leaf floated past the green bush and got stuck near a white wrapper. One cat pawed at it, slipping slightly on a slick pink patch of cement. They ended up chasing it in circles for ten minutes, then got tired and flopped down with a sigh that sounded very smal.\nThe night came quietly. A soft breeze moved through the purple shadows, and the stars reflected faintly in the red puddle. A black rat appeared near the fence but ran away before any cat noticed. The alley felt calm, like it was holding its breath. A distant train rumbled, shaking a few cans without waking anyone.\nWhile they slept, a moth flapped its wings near the blue crate and landed on a piece of orange cardboard. The youngest cat blinked awake and stared at it with glowing green eyes. For a moment, nothing moved. Then it jumped too early and missed, landing in a bucket and making a loud clank that echoed. The other cats didn’t even open their eyes, used to the noice.\nAs the sun rose, light touched the white fence, the edge of the pink wall, and the top of the yellow dumpster. The cats stretched, yawned, and blinked at the sky. It was a new day, same as the one before, and the one before that. But for them, the alley was home, and it was everything they ever wanted—even if it was a bit smelly and full of brokn things.",
    "Inside a locked toy store, when the lights turned off and the yellow sign stopped glowing, a group of pink mice came to life behind the blue shelves. They wore tiny bottle-cap hats and used old shoelaces as swings. Every night, they held races across the model train tracks, using soda caps for cars and jellybeans as prizes. One mouse always cheated but no one really minded becuse he was so fast.\nTheir leader was a mouse with a torn red ribbon around her tail. She carried a green flashlight and rode a wind-up dinosaur with white teeth. She led the crew through stuffed animal caves and across rivers made of spilled glitter. Last night, they had found a treasure chest full of buttons and got stuck inside for a full hour before someone remembered how to unlatch it. It had been very shinny.\nIn the puzzle aisle, the mice built forts from blocks and bounced on black rubber balls. One mouse tried to juggle plastic purple beads but sneezed halfway through and launched them everywhere. Another got trapped in a blue bucket and had to be fished out using a yo-yo. The whole group laughed until their whiskers shook and one mouse fell over from the giggles.\nBehind the dollhouse wall, they discovered a forgotten racecar track. The mice dragged it out using a green kite string and raced two toy cars down the lanes. The cars zoomed past the pink tents they had set up earlier and crashed into a stack of orange building bricks. Everyone clapped and one mouse held up a sock like a trophy, even though it was way too big and smelld odd.\nNear the plush bear mountain, a mouse with glitter on his ears tried to climb to the top. He slipped twice on a white ribbon but made it on the third try. From there, he could see the glowing lights of the candy display and a rolling black marble he’d lost three nights ago. He squeaked in joy and tumbled all the way down like a furry snowball, landing in a pile of yellow duck toys.\nAt midnight, the mice threw a dance party on a blue frisbee. One played music using a wind-up music box and another waved a broken red straw like a flag. They wore thimbles as helmets and spun around under the flicker of the purple fairy lights. Someone stepped on a squeaky toy and startled the whole group, but they went right back to dancing after a few seconds of silnce.\nLater, they built a raft out of popsicle sticks and sailed it across a puddle under the green water fountain. The current took them past a stack of black game boxes and into a loop of toy racetracks. One of the mice shouted “Adventure!” and they all started throwing bits of pink yarn into the air like streamers. Their raft tipped but they clung on like brave little pirates.\nAs the sky outside turned light and the yellow sun began to rise, the mice returned to their hidden hole behind the orange shelf. They curled up in tissue beds and yawned as the first worker’s keys jingled outside. Another night of chaos and fun was over. One mouse whispered “tomorrow, we fly the paper airplane” before falling into a dream filled with marshmallows and rubber blue ducks.",
    "Octopuses are some of the strangest creatures in the blue sea. They have three red hearts and green blood, which helps them survive in deep waters. Instead of bones, their bodies are squishy and soft so they can squeeze through tiny cracks. One was even seen escaping an aquarium tank using a tiny hole in a drain and it was wildy smart.\nEach of their eight arms has its own mind. Scientists learned that two thirds of an octopus’s neurons are in its arms not its head. That means each arm can taste feel and even make choices without asking the brain first. One black arm might be exploring a cave while a purple one is opening a yellow jar on the other side.\nOctopuses use color to talk. With special cells in their skin called chromatophores they can change color in an instant. A calm octopus might be white while an angry one turns red and a sneaky one blends into green seaweed. But oddly they are colorblind themselves and can’t actualy see the colors they become.\nome octopuses collect stuff. One species the veined octopus gathers pink coconut shells and hides inside them like armor. Others use orange rocks to build little walls around their dens or decorate with shiny blue bottle caps. It’s not clear if they do it for protection or just because they like the look but it sure is cute and weird.\nWhen threatened they can vanish in a puff of ink. The ink is black and sticky and it confuses predators long enough for the octopus to zoom away. They swim by shooting water from a white tube called a siphon kind of like a jetpack. It is not the most graceful method but it works unless they bump into a yellow sponge.\nOne amazing skill is mimicry. The mimic octopus can pretend to be other sea creatures like a red lionfish a blue flatfish or even a green sea snake. It changes its shape motion and behavior to scare off threats. Scientists were so shocked when they first saw it that they though it was a hoax.\nOctopuses are escape artists. They can unscrew lids walk across land for short times and solve puzzles. In labs some have turned off lights escaped tanks or even splashed water at researchers. One purple octopus kept stealing crabs from a pink bucket across the room while the scientist wasn’t looking. Eventually they had to move it to a black tank.\nadly octopuses don’t live long. Most only survive a year or two though some can reach five. After laying orange eggs the mother stays to protect them refusing to eat until she passes away. It’s a short but clever life. And while they may look like aliens from a sci fi movie they’re real smart and still full of secrets we havn’t figured out yet.",
    "Frogs are amazing creatures found almost everywhere on Earth from green rainforests to yellow deserts and even blue mountain lakes. They can live in water on land or both depending on the species. Most frogs begin life as tadpoles swimming with tails and gills before slowly growing legs. Some never grow out of the water and stay fully aquatic their whole lifes.\nFrogs do not drink water like we do. Instead they absorb it through their white belly skin which is super thin and sensitive. This is also why they must stay damp or they can dry out quickly. A pink frog sitting too long in the sun can get in real trouble unless it finds a shady black spot to rest.\nWhen it comes to jumping frogs are champions. Some species can leap over twenty times their body length in a single hop. This helps them catch prey or escape predators in a flash. A small red tree frog can bounce from leaf to leaf faster than your eye can follow while a blue bullfrog might just sit and wait near a green pond edge.\nFrogs make a lot of different sounds. Not all of them ribbit though that is just one type of call. Some growl others croak and a few even whistle. A purple frog from India sounds like a chicken and lives almost all of its life underground. It only comes out when the yellow monsoon rains arrive and the white soil turns to mud.\nMany frogs change colors. A black frog might turn green during the day and back again at night to stay camouflaged. Some even go orange or red when frightened to scare off attackers. Their skin contains special cells called chromatophores which shift the colors based on light mood or even temperature though this ability is not always perfect.\nFrogs eat with speed and stickiness. Their tongues are super fast and coated with a glue like slime that grabs insects in a blink. A blue frog can snatch a fly before the fly even moves. They do not chew but swallow whole and if they miss they just try again with a quick flick and a goofy little blink from their pink eyes while sitting on a green rock.\nSome frogs are poisonous but not all. The red poison dart frog for example gets its toxins from the bugs it eats in the wild. In captivity it is not toxic at all because it eats different food. A yellow frog with bright colors is often a warning to stay away while a plain black one might be totally harmless but still grumpy looking.\nSadly frog numbers are dropping fast around the world. Pollution habitat loss and a deadly fungus are big threats. Scientists are working hard to protect these amazing creatures and discover new ones too. A tiny purple frog was only found recently even though it had been living under our noses the whole time. Frogs may be small and sometimes slimy but they are incredible and full of secrets we still do not fully unerstand.",
    "Space is really just everything beyond Earth’s sky. It starts about 100 kilometers up where the blue atmosphere fades into blackness and gravity starts to weaken. Out there things float forever unless something stops them. That is why a white satellite keeps orbiting and a green wrench dropped during a spacewalk might still be spinning today.\nThe Moon is Earth’s closest neighbor and it affects us more than we notice. Its pull creates ocean tides and helps keep Earth’s tilt stable. Astronauts have walked on its dusty gray surface which reflects yellow sunlight during a full moon. Long ago people thought it was made of cheese which is not true but kind of hilarios to imagine.\nThe Sun is a giant star and it powers everything on Earth. Its core is millions of degrees hot and it takes light about eight minutes to reach us. Without it we would freeze in darkness and nothing could grow. It looks orange in the sky but it is really closer to white and only seems red at sunrise or sunset because of our air.\nOur solar system has eight planets each one different. Mercury is super hot Venus is covered in clouds Earth is just right and Mars is cold and dusty. Jupiter is the biggest and has a pink storm the size of Earth Saturn has yellow rings made of ice Uranus is blue and tilted sideways and Neptune is dark and windy.\nBetween planets there is a lot of empty space but also cool stuff like comets and asteroids. A black asteroid can zip past Earth at thousands of kilometers per hour while a purple comet might leave a trail of ice and dust glowing in the white sunlight. Some even come from the edge of the solar system where it is colder than anything on Earth.\nBeyond our solar system there are billions of stars and planets in the galaxy. Some are red giants burning bright others are blue and super hot. Many have planets we call exoplanets and some might even be like Earth. We cannot visit them yet because they are so far that even light takes years to travel but we keep looking anyawy.\nBlack holes are one of the strangest things out there. They form when big stars collapse and their gravity is so strong not even light can escape. If a green star gets too close it gets stretched and eaten. We only know black holes are there because of how they pull on other things like a yellow star or a pink cloud of gas.\nSpace is huge and full of mysteries. We have sent probes past Pluto taken pictures of blue galaxies and even found water on the Moon and Mars. But most of the universe is still unknown. Scientists think there is invisible stuff called dark matter and dark energy but no one really knows what it is yet. Space is amazing strange and full of things we do not yet undertsand."
];

const altPassages = [
    "Volcanoes are mountains that explode from the inside. Deep underground molten rock called magma builds up until it bursts through the surface. When it does it becomes lava which can glow red and burn through everything in its path. Sometimes it oozes slowly and other times it blasts out so fast it shoots black ash into the sky and turns the clouds gray.\nSome volcanoes are small bumps while others are taller than any building. Mauna Loa in Hawaii is one of the biggest on Earth and it rises from the blue ocean floor. There are also volcanoes under the sea where magma leaks through cracks and creates green islands. A new island was born near Tonga not long ago and it surprised everyone with how quikly it formed.\nVolcanoes are found where Earth’s plates meet and move. The crust is like a puzzle made of huge pieces that shift very slowly. Where they crash or pull apart magma rises up to fill the gaps. The Ring of Fire around the yellow Pacific Ocean is full of active volcanoes because the plates there are always moving. That is also why orange earthquakes happen near them so often. Some volcanoes even form far from plate edges like the white ones in Iceland.\nLava can take many forms. It might flow like hot syrup or crumble into jagged rocks as it cools. There are two famous types called pahoehoe which is smooth and a’a which is rough and sharp. If a pink lava flow hits water it can explode into steam and make brand new land. The new land is often rich and full of minerals which is why people live near volcanoes even though they are dangerus.\nWhen volcanoes erupt they do not just send out lava. They also release gases like carbon dioxide and sulfur which can create purple clouds and change weather patterns. In 1815 Mount Tambora erupted so strongly that it caused a black summer with snow in July and ruined crops across the world. Some people thought the world was ending but it was just a very grumpy green mountain.\nVolcanoes can sleep for hundreds or even thousands of years. When they erupt again it can be a surprise unless scientists are watching closely. They use seismometers to track red rumbling underground and satellites to watch the white surface for changes. If a volcano swells or leaks heat something big might be coming. But sometimes they trick everyone and go quiet again which is super anoying for volcanologists.\nThere are even volcanoes on other planets. Mars has Olympus Mons the tallest volcano in the solar system taller than three Mount Everests. Jupiter’s moon Io is covered in yellow lava lakes and shoots blue plumes into space. Even pink Venus has signs of past eruptions and might still be active though it is hard to study because of its thick atmosphere.\nVolcanoes are powerful beautiful and a little scary. They shape planets build islands and change the air itself. Some destroy everything nearby while others create land where life can grow. From orange lava rivers to green moss growing on cooled rock they show how the Earth is always alive and changing even if we do not always notice it happening under our feet.",
    "Mia lived in a quiet apartment with three black cats and a very fluffy white rug. Every morning, the cats would sit by the window and watch the blue sky change colors. They had their own spots: one on the sill, one on the chair, and one always in the laundry basket. Mia fed them on time, but often forgot which one liked tuna and which one hated it, causing some unhappy meows.\nOne day, the youngest cat knocked over a green vase while chasing a fly. Water spilled across the floor, soaking Mia’s pink socks. “Again?” she sighed, reaching for a yellow towel. The fly escaped, the vase cracked, and the cat sat down like it did nothing wrong. Mia slipped slightly and caught herslef on the table.\nAt lunchtime, the cats gathered near the orange kitchen mat and stared up with wide eyes. Mia made toast, but the smell of the purple cheese she used seemed to interest them more than usual. One of them climbed onto the red counter and tried to steal a bite. Mia turned just in time to stop him, though her plate flw off the edge.\nIn the afternoon, they all napped in the sun. One stretched out on the white windowsill, another curled up on the blue couch, and the third hid under the green bed. Mia took a picture but her camera lens was dusty. She laughed and cleaned it, then noticed the cat under the bed had somehow dragged her sock there yesturday.\nLater, Mia played with them using a string tied to a stick. The yellow string bounced and danced while the cats leaped in turns. The oldest one, wearing a black collar, didn’t move much but watched closely. The youngest pounced too hard and ran into a red wall, then got up like nothing happened, acting cool as always.\nEvening came and rain tapped gently on the blue windows. The cats looked outside at the dark orange sky, their tails twitching. One tried to tap the drops through the purple glass but ended up slipping. Mia giggled and grabbed a towel. Then she noticed the corner of the curtain had been ripped and she had no clue when it happned.\nBefore bed, Mia brushed each cat with a pink comb while they purred. The one with the white paws lay belly up, while the green eyed one tried to chew the brush instead. Mia sang a quiet song, not really in tune, but they seemed to like it. She put away the brush and sneezed once when fur floated into her nose by mistake.\nThe cats followed her into the bedroom and found their spots, one on the yellow pillow, one by the black chair, and one inside her red hoodie. Mia turned off the light and sighed happily. She loved living with them, even if her furniture was slowly being destoryed. She smiled and drifted off to sleep, surrounded by soft purring.",
    "Mark arrived at the white office building just as the blue sky was beginning to brighten. The smell of black coffee wafted through the lobby as he nodded to the receptionist and swiped his badge. His tie was crooked and his laptop bag half-open, but he didn’t notice his mind was on the morning meeting. He’d forgotten the repot at home and cursed under his breth.\nIn the green meeting room, fluorescent lights buzzed overhead as colleagues shuffled in. Carol wore her usual pink blazer, while Trevor sipped a yellow energy drink with too much sugar. Mark fumbled with his slides, praying no one would ask about the missing data. He accidently clicked on his vacation photos instead of the presentation, causing a few muffled laughes.\nAfter the meeting, Mark retreated to his black cubicle and pulled out his notes. He highlighted his todo list with a red marker, determined to catch up. His coworker Jen walked over in a purple cardigan, balancing two coffees. “Tough morning?” she asked. Mark nodded and knocked over his stapler in responce, spilling paper clips everywhere.\nThe rest of the day passed in a blue blur of emails, charts, and spreadsheet errors. The printer jammed again, blinking with a yellow warning light no one understood. Mark nearly shouted when it ate his report for the third time. He took a deep breath and stared out the green window blinds, wondering if he should’ve just called in sick.\nAt lunch, they sat in the white break room, eating leftovers under the dull orange lights. Carol told a story about her cat, while Jen complained about the lack of pink mugs again. Mark barely touched his food, still distracted by deadlines. When he bit into his sandwich, he realised he’d left the plastic wrap on. No one said anything, but Trevor snorted quitely.\nIn the afternoon, the team gathered for a surprise audit. Mark's black keyboard clacked rapidly as he searched for old emails. “Where’s the 2023 vendor contract?” the auditor asked. Mark pointed to a dusty red binder on the shelf. “There,” he said, hoping it was the right one. It wasn’t. The auditor frowned, and Mark’s stomache dropped.\nBy 5pm, the office lights dimmed and the purple sky peeked through the windows. Jen tossed a green stress ball at Mark’s head as a joke. “Weekend’s close,” she smiled. Mark laughed, tired but relieved. He grabbed his blue umbrella and packed his laptop, forgetting the charger in his drawer agian.\nOutside, the air was cool, and the pink clouds drifted over the horizon. Mark walked past the yellow streetlights, thinking about Monday. It hadn’t been a great day, but it wasn’t the worst either. He tightened his white coat and crossed the street, promising himself he’d be more ready tomorrow—even if he probbly wouldn't.",
    "Japan is an island nation in the Pacific Ocean made up of over 6000 islands. The four main ones are Honshu Hokkaido Kyushu and Shikoku and each one has something special. The country is known for its mix of old and new with red shrines and ancient temples standing beside white skyscrapers and glowing blue billboards.\nMount Fuji is Japan’s tallest mountain and it is actually a volcano though it has not erupted in a long time. It is perfectly cone shaped and people often climb it in summer to see the sunrise from the top. On clear days you can see pink cherry blossoms in bloom at the base while snow still rests on the black peak under the bright yellow sky.\nJapan is famous for its food and not just sushi. There is ramen with hot broth and noodles tempura which is fried seafood or veggies and sweet treats like mochi made of sticky green rice. Some restaurants even use orange robots to serve you or have food come by on a tiny white train at your table.\nTrains in Japan are some of the fastest in the world. The shinkansen or bullet train zooms through cities and mountains at over 300 kilometers per hour and arrives almost to the second. Inside it is smooth quiet and super clean. You might see the blue ocean on one side and purple rice fields on the other while sipping a warm tea in a black seat.\nJapanese culture values respect and detail. People bow when greeting each other and take off their shoes indoors. Schools teach kids to clean their own classrooms and lunch is eaten together in a quiet and polite way. In shops workers smile and say irasshaimase which means welcome while wearing neat white uniforms and tying up their red aprons beside the green shelves.\nTechnology is a big part of life in Japan. There are vending machines for everything from drinks to umbrellas and even soup. Cities glow at night with signs and games in arcades that never close. Some pink toilets even talk to you or play music while you use them which sounds fake but is totally real and kind of hilariuos. You might also see blue robots in stores or yellow delivery drones flying by.\nJapan also has beautiful nature. There are snow monkeys that sit in hot springs in winter and glowing fireflies in summer. The forests are full of mossy black trees old shrines and tiny paths where you might spot a green frog or a shy orange deer. In fall the leaves turn bright colors and people take special trips just to see them.\nEven though it is small Japan has had a huge impact on the world from anime and video games to cars and fashion. It has traditions going back thousands of years but still keeps inventing new things. Whether you are walking under purple lanterns in Kyoto eating sushi at a blue counter or riding a white train past a volcano Japan is full of surprises and coolness at every turn.",
    "Bioluminescence is when living things make their own light. It is not the same as glowing in the sunlight or reflecting a flashlight. These creatures actually produce light using chemicals inside their bodies. Most of them live in the black ocean where it is too dark to see and their blue glow helps them hunt hide or find a friend. Some even use green flashes like a secret signal in the deep.\nFireflies are the best known glow bugs on land. They light up their tails to attract mates and talk to each other. Each type has its own blink pattern kind of like a code. In summer they float over yellow fields blinking slowly while pink flowers wave in the warm air and the white moon rises above.\nIn the ocean many jellyfish glow with soft light. Some are clear with tiny glowing dots and others burst into color when they are touched. A jelly might flash red to scare away a predator or swirl blue trails as it moves. Some look like purple ribbons drifting in space instead of water.\nCertain squid and shrimp use light like ninja tricks. A deep sea shrimp can shoot glowing goo at an attacker then jet away while the predator is confused. Some squid flash their green lights on and off to hide their shadows from things below. Others have tiny orange lights under their eyes or on their arms like natural lamps in the black water.\nEven some fish glow in wild ways. The anglerfish lives deep down and has a glowing lure that hangs in front of its face to trick prey. It wiggles the blue light until a fish swims close and then snap. Other fish like lanternfish have yellow dots along their sides and can blink or change brightness to blend in or comunicate in the dark white sea.\nThere are glowing mushrooms too. Some grow on old green logs and shine softly at night like fairy lights. People used to call them foxfire and thought they were magical. Scientists now know they use enzymes to make the light and think it might help attract insects to spread their spores. A walk through a pink forest with glowing fungi would be like stepping into a dream under a black sky.\nEven some bacteria glow. These tiny creatures can make water shine in purple or blue when they gather in huge groups. In places like Puerto Rico you can kayak at night through glowing bays where every paddle splash lights up. Some glowing beaches even sparkle when you walk and it looks like white stars on the sand. It is so cool it almost looks fake but it is totally real.\nBioluminescence is not just pretty it is useful too. Scientists study it to learn about deep sea life and even use it in medicine. One glowing protein from a jellyfish helps them see how cells work. What started as a weird trick in orange fish or green worms might now help fight diseases. Nature is full of light in the most surprizing places.",
    "Coral reefs are often called the rainforests of the sea because of their rich diversity. They are made up of tiny creatures called corals that build hard shells around themselfs over time. These shells pile up to create huge underwater structures that shine under the blue water like white castles surrounded by pink fish.\nCorals might look like rocks but they are alive and very sensative. They use their tiny arms to grab food from the water and they also have colorful algae living inside them that help them grow. If the water gets too hot or dirty the green algae leave and the coral turns white and can die. This is called coral bleeching and it is a big problem.\nReefs are home to thousands of species including yellow seahorses red crabs and even black sharks. Every creature has a role to play from fish that clean the reef to others that hide from predators in its cracks. When you look closely you might see a shrimp waving its arms or a purple octopus changing color to match a rock. Nature gets very creative down there but it also very fragil.\nSome reefs like the Great Barrier Reef are so big they can be seen from space. This reef stretches along the coast of Australia and holds more marine life than anywhere else on Earth. Snorkelers float over blue corals and orange clams while white rays glide past below. It is like swimming in a living rainbow except sometimes the current is strong and you have to swim carfully.\nCoral reefs also help people. They act as natural barriers against storms slowing down waves before they hit the shore. They also bring in money from tourism and provide fish for millions of people. In places like the Maldives or the green Philippines reefs are part of everyday life. But sadly some are being dammaged by pollution overfishing or boats dragging their black anchors through the reef.\nScientists and divers around the world are working to protect and even rebuild coral reefs. Some plant baby corals onto broken areas using pink glue or special yellow frames that hold them in place. Others are making artificial reefs out of sunken ships or blue concrete blocks to give new corals a place to grow. It takes a long time though and it is very slow process.\nOne of the coolest things about coral reefs is how they glow at night. Some corals and animals give off a white or purple light through something called biofluorescence. Under special lights the whole reef looks like a glowing garden from a dream. Divers need to wear red filters on their masks to see it clearly and the effect is totaly magical.\nCoral reefs may seem small or far away but they are a big part of Earth’s health. They keep the oceans balanced provide food and protect coasts from harm. If we take care of the green reefs and reduce our impact they can recover and keep glowing for future gennerations. Saving coral is not just about fish it is about saving ourselvs too.",
]

let participantId = '';
let currentPassage = '';
let usedPassages = new Set();
let expectedText = '';
let sessionDuration = 2;
let currentSession = 1;
let sessionStartTime = 0;
let sessionTimer = null;
let breakTimer = null;
let experimentData = [];
let isExperimentActive = false;
let colorAssignments = {};
let isColorblindMode = false;
let alternate = false;

const SUPABASE_URL = 'https://vwkfphpdbfvjwzbfrdav.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3a2ZwaHBkYmZ2and6YmZyZGF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NjgyOTgsImV4cCI6MjA2NDQ0NDI5OH0.yGJMK4zjJ7Swy5bBDVqiK_fyaLoRI4cBLab6rYqsNnk';

// Create a single Supabase client instance
let supabaseClient = null;

function initializeSupabase() {
    if (supabaseClient) {
        return supabaseClient;
    }

    if (typeof window.supabase === 'undefined') {
        console.error('Supabase library not loaded');
        return null;
    }

    try {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase client created successfully');
        return supabaseClient;
    } catch (error) {
        console.error('Failed to create Supabase client:', error);
        return null;
    }
}

// Color word mappings
const colorWords = [
    'red', 'orange', 'yellow', 'green', 'blue', 'purple', 'pink', 'white', 'black',
    'silver', 'gold', 'golden', 'crimson', 'scarlet', 'amber', 'lime', 'emerald', 'jade',
    'sapphire', 'cobalt', 'navy', 'violet', 'magenta', 'rose', 'coral', 'turquoise',
    'cyan', 'maroon', 'burgundy', 'olive', 'khaki', 'tan', 'beige', 'ivory', 'gray', 'grey'
];

const colorblindColors = ['blue', 'green', 'black', 'white', 'red'];
const normalColors = ['red', 'orange', 'yellow', 'green', 'blue', 'purple', 'pink', 'white', 'black'];

function getRandomPassage() {
    const source = alternate ? altPassages : passages;
    if (usedPassages.size >= source.length) return;

    let passage;
    do {
        passage = source[Math.floor(Math.random() * source.length)];
    } while (usedPassages.has(passage));

    usedPassages.add(passage);
    return passage;
}

function passageIndex(passage, alternate = false) {
    const source = alternate ? altPassages : passages;
    return source.indexOf(passage);
}

function startExperiment() {
    isColorblindMode = document.getElementById('colorblindMode').checked;
    alternate = document.getElementById('alternate').checked;
    participantId = parseInt(document.getElementById('participantNumber').value);

    if (alternate) {
        sessionDuration = parseInt(document.getElementById('sessionDuration').value);
    }
    console.log('Session Duration:', sessionDuration, 'minutes');

    if (alternate) {
        console.log('Using alternate passages');
        document.getElementById('inputGroup').style.display = 'flex';
    }

    if (sessionDuration < 1) {
        alert('Please enter a valid duration (at least 1 minute)');
        return;
    }

    // Apply colorblind mode class
    document.body.classList.toggle('colorblind', isColorblindMode);

    // Show the stop button
    document.getElementById('stopButton').style.display = 'block';

    document.getElementById('setupScreen').style.display = 'none';
    document.getElementById('experimentScreen').style.display = 'flex';

    isExperimentActive = true;
    currentSession = 1;
    experimentData = [];

    startSession();
}

function startSession() {
    currentPassage = getRandomPassage();
    colorAssignments = {};

    assignColorsToPassage();
    createExpectedText();
    displayPassage();

    const inputArea = document.getElementById('inputArea');
    inputArea.value = '';
    inputArea.focus();

    sessionStartTime = Date.now();

    sessionTimer = setInterval(() => {
        console.log('Session Timer:', Math.floor((Date.now() - sessionStartTime) / 1000), 'seconds elapsed');
    }, 1000);

    setTimeout(() => {
        endSession();
    }, sessionDuration * 60 * 1000);
}

function assignColorsToPassage() {
    const availableColors = isColorblindMode ? colorblindColors : normalColors;
    const foundColorWords = new Set();
    const usedColors = new Set();

    // Find all color words in the passage
    const paragraphs = currentPassage.split('\n');
    paragraphs.forEach(paragraph => {
        const words = paragraph.split(/(\s+)/);
        words.forEach(word => {
            const cleanWord = word.toLowerCase().replace(/[^\w]/g, '');
            if (colorWords.includes(cleanWord)) {
                foundColorWords.add(cleanWord);
            }
        });
    });

    // Assign colors to each unique color word
    foundColorWords.forEach(colorWord => {
        const matchingBaseColor = getMatchingBaseColor(colorWord);
        let availableOptions = availableColors.filter(color =>
            color !== matchingBaseColor && !usedColors.has(color)
        );

        if (availableOptions.length === 0) {
            availableOptions = availableColors.filter(color => color !== matchingBaseColor);
            usedColors.clear();
        }

        const selectedColor = availableOptions[Math.floor(Math.random() * availableOptions.length)];
        usedColors.add(selectedColor);
        colorAssignments[colorWord] = selectedColor;
    });
}

function getMatchingBaseColor(colorWord) {
    const mappings = {
        'crimson': 'red', 'scarlet': 'red', 'maroon': 'red', 'burgundy': 'red',
        'amber': 'yellow', 'gold': 'yellow', 'golden': 'yellow', 'khaki': 'yellow', 'tan': 'yellow', 'beige': 'yellow',
        'lime': 'green', 'emerald': 'green', 'jade': 'green', 'olive': 'green',
        'sapphire': 'blue', 'cobalt': 'blue', 'navy': 'blue', 'turquoise': 'blue', 'cyan': 'blue',
        'violet': 'purple', 'magenta': 'purple',
        'rose': 'pink', 'coral': 'orange',
        'silver': 'white', 'ivory': 'white',
        'gray': 'black', 'grey': 'black'
    };
    return mappings[colorWord] || colorWord;
}

function createExpectedText() {
    // Create a regex pattern that matches all color words we need to replace
    const colorWordPattern = new RegExp(
        `\\b(${Object.keys(colorAssignments).join('|')})\\b`,
        'gi'
    );

    // Replace all color words in one pass
    expectedText = currentPassage.replace(colorWordPattern, (match) => {
        const lowerMatch = match.toLowerCase();
        return colorAssignments[lowerMatch] || match;
    });
}

function displayPassage() {
    const passageElement = document.getElementById('passageText');
    let displayText = '';

    const paragraphs = currentPassage.split('\n');
    paragraphs.forEach((paragraph, paragraphIndex) => {
        if (paragraphIndex > 0) {
            displayText += '\n';
        }

        const words = paragraph.split(/(\s+)/);
        words.forEach(word => {
            const cleanWord = word.toLowerCase().replace(/[^\w]/g, '');

            if (colorWords.includes(cleanWord) && colorAssignments[cleanWord]) {
                const highlightClass = `highlight-${colorAssignments[cleanWord]}`;
                displayText += `<span class="${highlightClass}">${word}</span>`;
            } else {
                displayText += word;
            }
        });
    });

    passageElement.innerHTML = displayText;
}

async function endSession() {
    if (!isExperimentActive) return;

    clearInterval(sessionTimer);

    const sessionEndTime = Date.now();
    await logDataToSupabase(sessionEndTime);

    if (currentSession < 6) {
        startBreak();
    } else {
        showCompletion();
    }
}

async function logDataToSupabase(sessionEndTime) {
    const supabase = initializeSupabase();
    if (!supabase) {
        console.error('Failed to initialize Supabase client');
        // Fall back to local storage
        logData();
        return;
    }

    const inputText = document.getElementById('inputArea').value;

    const sessionData = {
        participant_id: participantId,
        session_number: currentSession,
        passage_index: passageIndex(currentPassage, alternate),
        typed_text: inputText,
        expected_text: expectedText,
        duration_minutes: sessionDuration,
        is_alternate: alternate,
        is_colorblind: isColorblindMode,
        color_assignments: colorAssignments,
        session_start_time: new Date(sessionStartTime).toISOString(),
        session_end_time: new Date(sessionEndTime).toISOString()
    };

    try {
        console.log('Attempting to save session data:', sessionData);

        const { data, error } = await supabase
            .from('Experiments')
            .insert([sessionData])
            .select();

        if (error) {
            console.error('Error saving session data:', error);
            console.error('Error details:', error.message, error.details, error.hint);
            logData(); // Backup to local
        } else {
            console.log('Session data saved successfully:', data);
        }
    } catch (err) {
        console.error('Failed to connect to database:', err);
        logData(); // Backup to local
    }
}

function logData() {
    const inputText = document.getElementById('inputArea').value;

    const sessionData = {
        participant: participantId,
        session: currentSession,
        passage: passageIndex(currentPassage, alternate),
        typedText: inputText,
        expectedText: expectedText,
        duration: sessionDuration,
        alternate: alternate,
        colorblindMode: isColorblindMode,
        colorAssignments: { ...colorAssignments },
        timestamp: new Date().toISOString()
    };

    experimentData.push(sessionData);

    // Store in localStorage as backup
    try {
        const existingData = JSON.parse(localStorage.getItem('typingExperimentData') || '[]');
        existingData.push(sessionData);
        localStorage.setItem('typingExperimentData', JSON.stringify(existingData));
        console.log('Data saved to localStorage as backup');
    } catch (e) {
        console.error('Failed to save to localStorage:', e);
    }
}

async function getParticipantData(participantId) {
    const supabase = initializeSupabase();
    if (!supabase) return null;

    try {
        const { data, error } = await supabase
            .from('Experiments')
            .select('*')
            .eq('participant_id', participantId)
            .order('session_number');

        if (error) {
            console.error('Error fetching participant data:', error);
            return null;
        }

        return data;
    } catch (err) {
        console.error('Failed to fetch data:', err);
        return null;
    }
}

async function getAllExperimentData() {
    const supabase = initializeSupabase();
    if (!supabase) return null;

    try {
        const { data, error } = await supabase
            .from('Experiments')
            .select('*')
            .order('participant_id, session_number');

        if (error) {
            console.error('Error fetching experiment data:', error);
            return null;
        }

        return data;
    } catch (err) {
        console.error('Failed to fetch data:', err);
        return null;
    }
}

function startBreak() {
    document.getElementById('experimentScreen').style.display = 'none';
    document.getElementById('breakScreen').style.display = 'flex';

    let breakTime = 30;
    document.getElementById('breakTimer').textContent = breakTime;

    breakTimer = setInterval(() => {
        breakTime--;
        document.getElementById('breakTimer').textContent = breakTime;

        if (breakTime <= 0) {
            clearInterval(breakTimer);
            document.getElementById('breakScreen').style.display = 'none';
            document.getElementById('experimentScreen').style.display = 'flex';
            currentSession++;
            startSession();
        }
    }, 1000);
}

function showCompletion() {
    isExperimentActive = false;
    console.log(experimentData);
    document.getElementById('stopButton').style.display = 'none';
    document.getElementById('experimentScreen').style.display = 'none';
    document.getElementById('breakScreen').style.display = 'none';
    document.getElementById('completionScreen').style.display = 'flex';

    console.log('Experiment data:', experimentData);

    // Show data export option
    displayDataExportOption();
}

function displayDataExportOption() {
    const completionScreen = document.getElementById('completionScreen');
    if (!completionScreen.querySelector('#exportData')) {
        const exportButton = document.createElement('button');
        exportButton.id = 'exportData';
        exportButton.textContent = 'Download Data as JSON';
        exportButton.onclick = exportData;
        completionScreen.appendChild(exportButton);
    }
}

function exportData() {
    const allData = {
        experimentData: experimentData,
        localStorageData: JSON.parse(localStorage.getItem('typingExperimentData') || '[]'),
        exportTime: new Date().toISOString(),
        participantId: participantId
    };

    const dataStr = JSON.stringify(allData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});

    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `typing_experiment_participant_${participantId}_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

async function stopExperiment() {
    isExperimentActive = false;
    if (document.getElementById('experimentScreen').style.display === 'flex') {
        const sessionEndTime = Date.now();
        await logDataToSupabase(sessionEndTime);
    }
    clearInterval(sessionTimer);
    clearInterval(breakTimer);
    showCompletion();
}

// Test database connection function
async function testDatabaseConnection() {
    const supabase = initializeSupabase();
    if (!supabase) {
        console.log('Supabase client could not be created');
        return false;
    }

    try {
        // Test a simple query to check if the table exists
        const { data, error } = await supabase
            .from('Experiments')
            .select('count')
            .limit(1);

        if (error) {
            console.error('Database connection test failed:', error.message);
            return false;
        }

        console.log('Database connection successful');
        return true;
    } catch (err) {
        console.error('Database connection test error:', err);
        return false;
    }
}

// Event listeners
document.getElementById('inputArea').addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
        e.preventDefault();
    }
});

document.getElementById('alternate').addEventListener('change', function() {
    if (this.checked) {
        document.getElementById('inputGroup').style.display = 'flex';
    } else {
        document.getElementById('inputGroup').style.display = 'none';
    }
});

// Initialize
document.getElementById('setupScreen').style.display = 'flex';
document.getElementById('stopButton').style.display = 'none';

// Test database connection on page load
window.addEventListener('load', () => {
    console.log('Testing database connection...');
    testDatabaseConnection();
});
